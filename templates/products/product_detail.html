{% extends 'base.html' %}
{% load product_filters %}

{% block content %}
<div class="container mt-4">
    <!-- –•–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'product_list' %}">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</a></li>
            <li class="breadcrumb-item active">{{ product.name|truncatewords:3 }}</li>
        </ol>
    </nav>

    <div class="row">
        <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-body text-center">
                    <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å ID –¥–ª—è —Å–∫—Ä–∏–ø—Ç–∞ -->
                    {% if product.image %}
                        <img src="{{ product.image.url }}" class="img-fluid rounded mb-3" alt="{{ product.name }}"
                             style="max-height: 400px; object-fit: contain;" id="main-product-image">
                    {% else %}
                        <div class="bg-light rounded d-flex align-items-center justify-content-center"
                             style="height: 400px;">
                            <span class="text-muted fs-4">–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</span>
                        </div>
                    {% endif %}

                    <!-- –£–õ–£–ß–®–ï–ù–ù–ê–Ø –ì–ê–õ–ï–†–ï–Ø –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–• –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô -->
                    {% if product.images.all %}
                    <div class="mt-4">
                        <h6 class="text-muted mb-3">
                            üì∑ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–æ—Ç–æ ({{ product.images.count }})
                        </h6>
                        <div class="row g-2 justify-content-center">
                            {% for product_image in product.images.all %}
                            <div class="col-4 col-sm-3">
                                <div class="position-relative">
                                    <img src="{{ product_image.image.url }}"
                                         class="img-thumbnail gallery-thumbnail"
                                         alt="{{ product.name }}"
                                         style="height: 80px; width: 100%; object-fit: cover; cursor: pointer;"
                                         onclick="changeMainImage('{{ product_image.image.url }}')"
                                         onmouseover="this.style.opacity='0.8'"
                                         onmouseout="this.style.opacity='1'">
                                    <small class="position-absolute top-0 start-0 bg-dark text-white px-1">
                                        {{ forloop.counter }}
                                    </small>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-body">
                    <h1 class="h2 mb-3">{{ product.name }}</h1>

                    <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏—è -->
                    {% if product.category %}
                    <div class="mb-2">
                        <span class="badge bg-info text-dark">{{ product.category.name }}</span>
                    </div>
                    {% endif %}

                    <!-- –¶–µ–Ω–∞ -->
                    <div class="mb-4">
                        <span class="display-6 text-primary">{{ product.price|format_price }}</span>
                    </div>

                    <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
                    <div class="mb-4">
                        <h3 class="h5">üìù –û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</h3>
                        <p class="text-muted" style="line-height: 1.6;">
                            {{ product.description|linebreaksbr|default:"–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç" }}
                        </p>
                    </div>

                    <!-- –ú–∞–≥–∞–∑–∏–Ω—ã -->
                    {% if product.shop_addresses %}
                    <div class="mb-4">
                        <h3 class="h5">üìç –ì–¥–µ –∫—É–ø–∏—Ç—å</h3>
                        <div class="bg-light rounded p-3">
                            {% with addresses=product.shop_addresses.splitlines %}
                                {% for address in addresses %}
                                    {% if address.strip %}
                                        <div class="mb-2">
                                            <i class="bi bi-geo-alt text-primary"></i>
                                            {{ address.strip }}
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            {% endwith %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ -->
                    <div class="mb-4">
                        <h3 class="h5">‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                        <div class="small text-muted">
                            <div>–î–æ–±–∞–≤–ª–µ–Ω: {{ product.created_at|date:"d.m.Y" }}</div>
                            {% if product.created_by %}
                            <div>–ü—Ä–æ–¥–∞–≤–µ—Ü: {{ product.created_by.username }}</div>
                            {% endif %}
                            <div>–°—Ç–∞—Ç—É—Å: {% if product.is_active %}‚úÖ –ê–∫—Ç–∏–≤–µ–Ω{% else %}‚ùå –ù–µ–∞–∫—Ç–∏–≤–µ–Ω{% endif %}</div>
                        </div>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∏ -->
                    <div class="d-grid gap-2 d-md-flex">
                        <a href="{% url 'product_list' %}" class="btn btn-outline-primary">
                            ‚Üê –ù–∞–∑–∞–¥ –∫ –∫–∞—Ç–∞–ª–æ–≥—É
                        </a>
                        {% if user.is_authenticated %}
                            <a href="{% url 'add_to_cart' product.id %}" class="btn btn-primary ms-md-2">
                                üì¶ –í –∫–æ—Ä–∑–∏–Ω—É
                            </a>
                        {% else %}
                            <a href="{% url 'login' %}?next={% url 'product_detail' product.id %}" class="btn btn-primary ms-md-2">
                                üì¶ –í –∫–æ—Ä–∑–∏–Ω—É (—Ç—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥)
                            </a>
                        {% endif %}
                    </div>

                    <!-- –î–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ - —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ -->
                    {% if user.is_authenticated and user.role == 'manager' or user.role == 'admin' %}
                    <div class="mt-3 pt-3 border-top">
                        <a href="{% url 'product_edit' product.id %}" class="btn btn-outline-warning btn-sm">
                            ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .gallery-thumbnail {
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    .gallery-thumbnail:hover {
        border-color: #0d6efd;
        transform: scale(1.05);
    }
    .gallery-thumbnail.active {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
</style>

<script>
    function changeMainImage(imageUrl) {
        const mainImage = document.getElementById('main-product-image');
        if (mainImage) {
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é —Å–º–µ–Ω—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            mainImage.style.opacity = '0.7';
            setTimeout(() => {
                mainImage.src = imageUrl;
                mainImage.style.opacity = '1';
            }, 150);
        }

        // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –º–∏–Ω–∏–∞—Ç—é—Ä—É
        const thumbnails = document.querySelectorAll('.gallery-thumbnail');
        thumbnails.forEach(thumb => {
            thumb.classList.remove('active');
            if (thumb.src.includes(imageUrl)) {
                thumb.classList.add('active');
            }
        });
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–µ—Ä–≤—É—é –º–∏–Ω–∏–∞—Ç—é—Ä—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', function() {
        const firstThumbnail = document.querySelector('.gallery-thumbnail');
        if (firstThumbnail) {
            firstThumbnail.classList.add('active');
        }
    });
</script>
{% endblock %}